<!DOCTYPE html><html lang="pt-BR"><head><meta charset="UTF-8">
<title>Feed</title>
<style>/* Simplificado */</style></head><body>
<button onclick="window.location='search.html'">Buscar Usu√°rio</button>
<h2>Stories</h2><div id="stories"></div>
<h2>Novo Post</h2>
<textarea id="txt"></textarea><br/>
<input type="file" id="img" accept="image/*"><br/>
<button onclick="newPost()">Postar</button>
<div id="feed"></div>
<script>
const data = JSON.parse(localStorage.getItem('lilyData')||'{}');
function api(action, body) {
  return fetch(`/api/posts.js?user=${encodeURIComponent(JSON.stringify(data.user))}`, {
    method: 'POST', headers: {'Content-Type':'application/json'},
    body: JSON.stringify({action,...body})
  }).then(r=>r.json());
}

function loadFeed(){
  fetch('/api/posts.js')
    .then(r=>r.json())
    .then(ps=>{document.getElementById('feed').innerHTML = ps.map(p=>`
      <div style="border:1px solid #ccc;padding:10px">
        <img src="${p.avatar}" width="30"> <b>${p.author}</b>
        <p>${p.content}</p>
        ${p.image ? `<img src="${p.image}" width="100">` : ''}
        <p>‚ù§Ô∏è${p.likes.length} üí¨${p.comments.length}</p>
        <button onclick="like(${p.id})">Curtir</button>
        <input id="c${p.id}" placeholder="Coment√°rio"><button onclick="comment(${p.id})">Comentar</button>
      </div>`).join('');});
}
function newPost(){
  const txt = document.getElementById('txt').value;
  const file = document.getElementById('img').files[0];
  if(file){
    const reader = new FileReader();
    reader.onload = ()=> {
      api('create', {content:txt,image:reader.result}).then(loadFeed);
    };
    reader.readAsDataURL(file);
  } else api('create',{content:txt}).then(loadFeed);
}
function like(id){ api('like',{id}).then(loadFeed); }
function comment(id){
  const txt = document.getElementById('c'+id).value;
  api('comment',{id,text:txt}).then(loadFeed);
}
loadFeed();

// stories
fetch(`/api/stories.js?user=${encodeURIComponent(JSON.stringify(data.user))}`)
  .then(r=>r.json()).then(sts=>{
    document.getElementById('stories').innerHTML =
       sts.map(s=>`<img onclick="viewStory('${s.user}')" src="${s.image}" width="60">`).join('');
  });
</script>
</body></html>
