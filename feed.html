<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <title>Feed ‚Äì Lily Social</title>
  <style>
    * { box-sizing: border-box; margin:0; padding:0; font-family: 'Segoe UI', sans-serif; }
    body { background: #2f3136; color: #dcddde; }
    nav { background: #202225; padding: 10px 20px; display: flex; align-items: center; }
    nav a { color: #b9bbbe; margin-right: 20px; text-decoration: none; font-weight: 500; }
    nav a.active, nav a:hover { color: #fff; }
    nav .spacer { flex:1; }
    nav button { background: #5865F2; border:none; padding:6px 12px; border-radius:4px; color:white; cursor:pointer; }
    .container { max-width: 600px; margin:20px auto; }
    .new-post { background: #36393f; padding:15px; border-radius:8px; margin-bottom:20px; }
    .new-post textarea { width:100%; height:80px; background:#2f3136; border:1px solid #202225; border-radius:4px; color:white; padding:8px; }
    .new-post input[type=file] { margin-top:10px; color: #b9bbbe; }
    .new-post button { margin-top:10px; background:#5865F2; border:none; padding:8px 16px; border-radius:4px; color:white; cursor:pointer; }
    .post { background: #36393f; padding:15px; border-radius:8px; margin-bottom:20px; }
    .post-header { display:flex; align-items:center; }
    .post-header img { width:40px; height:40px; border-radius:50%; margin-right:10px; }
    .post-content img { max-width:100%; border-radius:6px; margin-top:10px; }
    .actions { margin-top:10px; }
    .actions button { background:#7289da; border:none; padding:6px 10px; border-radius:4px; color:white; cursor:pointer; margin-right:8px; }
    .comments { margin-top:10px; }
    .comments input { width:75%; padding:6px; border-radius:4px; border:1px solid #202225; background:#2f3136; color:white; }
    .comments button { padding:6px 10px; margin-left:6px; }
    #stories { display:flex; overflow-x:auto; padding:10px 0; }
    #stories img { width:60px; height:60px; border-radius:50%; margin-right:10px; border:2px solid #5865F2; cursor:pointer; }
  </style>
</head>
<body>
  <nav>
    <a href="feed.html" class="active">Feed</a>
    <a href="profile.html">Perfil</a>
    <a href="search.html">Buscar</a>
    <a href="games.html">Jogos</a>
    <div class="spacer"></div>
    <button onclick="logout()">Logout</button>
  </nav>

  <div class="container">
    <div id="stories"></div>

    <div class="new-post">
      <textarea id="txt" placeholder="O que est√° pensando?"></textarea>
      <input type="file" id="img" accept="image/*"/>
      <button onclick="newPost()">Postar</button>
    </div>

    <div id="feed"></div>
  </div>

  <script>
    const data = JSON.parse(localStorage.getItem('lilyData')||'{}');
    if(!data.user) return logout();

    function logout(){
      localStorage.clear();
      location.href = 'index.html';
    }

    async function loadFeed(){
      const posts = await fetch('/api/posts.js?user='+encodeURIComponent(JSON.stringify(data.user))).then(r=>r.json());
      document.getElementById('feed').innerHTML = posts.map(p=>`
        <div class="post">
          <div class="post-header">
            <img src="${p.avatar}" alt="avatar"/>
            <strong>${p.author}</strong>
          </div>
          <div class="post-content">
            <p>${p.content}</p>
            ${p.image?`<img src="${p.image}">`:''}
          </div>
          <div class="actions">
            <button onclick="like(${p.id})">‚ù§Ô∏è ${p.likes.length}</button>
            <button onclick="showComments(${p.id})">üí¨ ${p.comments.length}</button>
          </div>
          <div class="comments" id="cmt${p.id}" style="display:none;">
            ${p.comments.map(c=>`<p><strong>${c.user}:</strong> ${c.text}</p>`).join('')}
            <input id="in${p.id}" placeholder="Comentar..."/><button onclick="comment(${p.id})">Enviar</button>
          </div>
        </div>
      `).join('');
    }

    function newPost(){
      const txt = document.getElementById('txt').value;
      const file = document.getElementById('img').files[0];
      if(file){
        const fr = new FileReader();
        fr.onload = ()=>apiCreate(txt, fr.result);
        fr.readAsDataURL(file);
      } else apiCreate(txt,null);
    }
    function apiCreate(content,image){
      fetch('/api/posts.js?user='+encodeURIComponent(JSON.stringify(data.user)),{
        method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({action:'create',content,image})
      }).then(()=>{ document.getElementById('txt').value=''; document.getElementById('img').value=''; loadFeed(); });
    }

    function like(id){
      fetch('/api/posts.js?user='+encodeURIComponent(JSON.stringify(data.user)),{
        method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({action:'like',id})
      }).then(loadFeed);
    }
    function showComments(id){
      const el = document.getElementById('cmt'+id);
      el.style.display = el.style.display==='none'?'block':'none';
    }
    function comment(id){
      const txt = document.getElementById('in'+id).value;
      fetch('/api/posts.js?user='+encodeURIComponent(JSON.stringify(data.user)),{
        method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({action:'comment',id,text:txt})
      }).then(()=>loadFeed());
    }

    // stories
    fetch('/api/stories.js?user='+encodeURIComponent(JSON.stringify(data.user)))
      .then(r=>r.json())
      .then(sts=>{
        document.getElementById('stories').innerHTML = sts.map(s=>
          `<img src="${s.image}" title="${s.user}" onclick="alert('Story de ${s.user}')">`
        ).join('');
      });

    loadFeed();
  </script>
</body>
</html>
