<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard da Lily</title>
  <style>
    :root { --bg:#18191c; --panel:#2f3136; --accent:#5865F2; --error:#f04747; --success:#43b581; --text:#fff; --muted:#b9bbbe; }
    body { margin:0; padding:0; font-family:'Segoe UI',T sans-serif; background:var(--bg); color:var(--text); display:flex; justify-content:center; align-items:center; min-height:100vh; text-align:center; }
    .dashboard { background:var(--panel); padding:30px; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,0.3); width:95%; max-width:650px; }
    .user-info { display:flex; align-items:center; gap:16px; margin-bottom:25px; }
    .user-info img { border-radius:50%; width:70px; height:70px; border:2px solid var(--accent); }
    .guild-list { list-style:none; padding:0; margin:0; }
    .guild-list li { display:flex; align-items:center; background:#40444b; padding:12px 16px; border-radius:8px; margin-bottom:12px; transition:background .2s; cursor:pointer; }
    .guild-list li:hover { background:var(--accent); }
    .guild-icon { width:40px; height:40px; border-radius:50%; object-fit:cover; background:var(--panel); }
    .guild-name { font-weight:600; color:var(--text); flex-grow:1; margin-left:12px; text-align:left; }
    .status-bot { font-size:.8rem; font-weight:bold; background:#23272a; padding:4px 8px; border-radius:6px; color:var(--success); }
    .status-bot.absent { color:var(--error); }
    .loading, .error { font-size:1.2rem; margin-top:20px; }
    .error { color:var(--error); }
    @media (max-width:480px) {
      .user-info { flex-direction:column; align-items:center; }
      .guild-name { text-align:center; margin:0; }
      .guild-list li { flex-direction:column; align-items:center; gap:8px; }
    }
  </style>
</head>
<body>
  <div id="root">
    <div class="loading">Carregando informações do Discord...</div>
  </div>
  <script>
    async function getQueryParam(p){return new URLSearchParams(location.search).get(p);}
    async function fetchUserData(code){
      const res = await fetch(`/api/callback?code=${code}`);
      if(!res.ok) throw new Error("Erro ao obter dados");
      return res.json();
    }
    function renderDashboard(d){
      const root = document.getElementById("root"); root.innerHTML="";
      const dash = document.createElement("div"); dash.classList.add("dashboard");
      const ui = document.createElement("div"); ui.classList.add("user-info");
      ui.innerHTML = `<img src="${d.user.avatarUrl}" alt="Avatar"/><div><h2>Olá, ${d.user.username}!</h2><p style="color:var(--muted);font-size:.9rem;">ID: ${d.user.id}</p></div>`;
      dash.append(ui);
      const ul = document.createElement("ul"); ul.classList.add("guild-list");
      if(!d.guilds.length){
        ul.innerHTML=`<li><span class="guild-name">Você não tem servidores com permissões suficientes.</span></li>`;
      } else {
        d.guilds.forEach(g=>{
          const li=document.createElement("li");
          const cls = g.hasBot?"status-bot":"status-bot absent";
          li.innerHTML=`
            <img class="guild-icon" src="https://cdn.discordapp.com/icons/${g.id}/${g.icon}.png" onerror="this.src='https://via.placeholder.com/40?text=?'"/>
            <span class="guild-name">${g.name}</span>
            <span class="${cls}">${g.hasBot?"Bot presente":"Bot ausente"}</span>`;
          li.onclick=()=> location.href=`/guild.html?id=${g.id}`;
          ul.append(li);
        });
      }
      dash.append(ul); root.append(dash);
    }
    (async()=>{
      const code = await getQueryParam("code");
      if(!code) return document.getElementById("root").innerHTML = '<p class="error">Código OAuth2 ausente na URL.</p>';
      try{ renderDashboard(await fetchUserData(code)); }
      catch(e){ document.getElementById("root").innerHTML = `<p class="error">Erro: ${e.message}</p>`; }
    })();
  </script>
</body>
</html>
